{:paths ["src" "resources" "tasks"]
 :deps {org.clojure/tools.cli {:mvn/version "0.4.1"}
        commons-validator/commons-validator {:mvn/version "1.7"}
        org.babashka/http-client {:mvn/version "0.4.22"}
        cheshire/cheshire {:mvn/version "5.13.0"}}
 :tasks
 {:requires ([babashka.process :refer [shell]]
             [babashka.fs :as fs])
  :init (do
          (def cli-args *command-line-args*)
          (load-file "tasks/util.clj")
          (load-file "tasks/build.clj")
          (load-file "tasks/baseline.clj")
          (alias 'build 'tasks.build)
          (alias 'base 'tasks.baseline))

  ;; Main proserunner task (named 'lint' to avoid conflict with proserunner file)
  lint {:doc "Run proserunner linter on markdown files"
        :requires ([proserunner.core :as core])
        :task (apply core/-main cli-args)}

  ;; Test task
  test {:doc "Run Clojure test suite"
        :task (shell "clojure -M:test")}

  ;; Baseline tasks (from tasks/baseline.clj)
  baseline {:doc "Run benchmarks and compare against saved baseline"
            :task (apply base/baseline *command-line-args*)}

  update-baseline {:doc "Run benchmarks and save as new baseline"
                   :task (base/update-baseline)}

  ;; Build tasks (from tasks/build.clj)
  build {:doc "Build native binary (requires GraalVM native-image)"
         :task (build/build)}

  benchmark-build {:doc "Benchmark current native binary performance"
                   :task (build/benchmark-build)}

  ;; Installation tasks
  install {:doc "Build native binary and install to ~/.local/bin"
           :task (do
                   (println "=== Building proserunner ===\n")
                   (build/build)
                   (println "\n=== Installing to ~/.local/bin ===\n")
                   (when-not (fs/exists? "proserunner-binary")
                     (println "ERROR: proserunner-binary not found. Build may have failed.")
                     (System/exit 1))
                   (fs/create-dirs (str (System/getProperty "user.home") "/.local/bin"))
                   (let [target (str (System/getProperty "user.home") "/.local/bin/proserunner")]
                     (fs/copy "proserunner-binary" target {:replace-existing true})
                     (fs/set-posix-file-permissions target "rwxr-xr-x")
                     (println "✓ Installed to" target)
                     (println "\nMake sure ~/.local/bin is in your PATH:")
                     (println "  export PATH=\"$HOME/.local/bin:$PATH\"")
                     (println "\nVerify installation:")
                     (println "  proserunner --version")))}

  install-wrapper {:doc "Install wrapper script to ~/.local/bin (no build required)"
                   :task (do
                           (println "=== Installing proserunner wrapper ===\n")
                           (when-not (fs/exists? "proserunner")
                             (println "ERROR: proserunner wrapper script not found.")
                             (println "Make sure you are running this from the proserunner directory.")
                             (System/exit 1))
                           (fs/create-dirs (str (System/getProperty "user.home") "/.local/bin"))
                           (let [target (str (System/getProperty "user.home") "/.local/bin/proserunner")]
                             (fs/copy "proserunner" target {:replace-existing true})
                             (fs/set-posix-file-permissions target "rwxr-xr-x")
                             (println "✓ Installed wrapper to" target)
                             (println "\nMake sure ~/.local/bin is in your PATH:")
                             (println "  export PATH=\"$HOME/.local/bin:$PATH\"")
                             (println "\nThe wrapper will use clojure or bb automatically.")
                             (println "No native compilation required!")))}

  install-system {:doc "Build native binary and install to /usr/local/bin (needs sudo)"
                  :task (do
                          (println "=== Building proserunner ===\n")
                          (build/build)
                          (println "\n=== Installing to /usr/local/bin (requires sudo) ===\n")
                          (when-not (fs/exists? "proserunner-binary")
                            (println "ERROR: proserunner-binary not found. Build may have failed.")
                            (System/exit 1))
                          (shell "sudo cp proserunner-binary /usr/local/bin/proserunner")
                          (shell "sudo chmod +x /usr/local/bin/proserunner")
                          (println "✓ Installed to /usr/local/bin/proserunner")
                          (println "\nVerify installation:")
                          (println "  proserunner --version"))}}}
